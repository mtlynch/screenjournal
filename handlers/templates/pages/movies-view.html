{{ define "style-tags" }}
  <style nonce="{{ .CspNonce }}">
    @media screen and (min-width: 768px) {
      .poster {
        max-width: 250px;
      }
    }

    .metadata {
      font-size: 0.85em;
    }

    .review {
      max-width: 70ch;
    }

    .review + .review {
      margin-top: 2rem;
    }

    .review p {
      max-width: 100%;
    }
  </style>
{{ end }}

{{ define "script-tags" }}
{{ end }}

{{ define "custom-elements" }}
{{ end }}

{{ define "content" }}

  {{ with .Movie }}
    <h1>{{ .Title }}</h1>
    <img
      class="card-img-top poster"
      src="{{ posterPathToURL .PosterPath }}"
      alt="Movie poster for {{ .Title }}"
    />
    <ul class="metadata mt-2">
      <li class="release-date">
        Released:
        {{ formatReleaseDate .ReleaseDate }}
      </li>

      {{ if .ImdbID }}
        <li>
          <a href="https://www.imdb.com/title/{{ .ImdbID }}">IMDB</a>
        </li>
      {{ else if .TmdbID }}
        <li>
          <a href="https://www.themoviedb.org/tv/{{ .TmdbID }}">TMDB</a>
        </li>
      {{ end }}
    </ul>
  {{ end }}


  <a
    href="/reviews/new?movieId={{ .Movie.ID }}"
    class="btn btn-primary my-3"
    role="button"
    >Add Rating</a
  >

  {{ range .Reviews }}
    <div class="review mb-5" data-review-id="{{ .ID }}">
      <div class="border bg-light p-2" id="review{{ .ID }}">
        <h6 class="card-subtitle mb-2 text-muted">
          <b><a href="/reviews/by/{{ .Owner }}">{{ .Owner }}</a></b> watched
          this
          <span data-testid="watch-date" title="{{ formatWatchDate .Watched }}"
            >{{ relativeWatchDate .Watched }}</span
          >
        </h6>
        <div data-testid="rating">
          {{ range iterate .Rating.UInt8 }}
            <i class="fa-solid fa-star"></i>
          {{ end }}
          {{ range iterate (minus 5 .Rating.UInt8) }}
            <i class="fa-regular fa-star"></i>
          {{ end }}
        </div>

        {{ with .Blurb }}
          <p data-testid="blurb" class="mb-0">
            {{ range .String | splitByNewline }}
              {{ . }}<br />
            {{ end }}
          </p>
        {{ end }}
      </div>

      <div class="d-flex flex-column justify-content-start ms-3 w-75">
        <div class="comment-thread">
          {{ range .Comments }}
            {{ template "comment" . }}
          {{ end }}
        </div>
        <div class="d-flex justify-content-end">
          {{ template "add-comment-button" . }}
        </div>
      </div>
    </div>
  {{ end }}
{{ end }}

{{ block "add-comment-button" . }}
  <button
    type="button"
    class="btn btn-secondary mt-2"
    hx-get="/api/comments/new?reviewId={{ .ID }}"
    hx-swap="outerHTML"
  >
    Comment
  </button>
{{ end }}

{{ block "comment" . }}
  <div
    id="comment{{ .ID }}"
    data-sj-purpose="comment"
    data-comment-id="{{ .ID }}"
    class="comment border my-1 p-2"
  >
    <p class="mb-2">
      <b><a href="/reviews/by/{{ .Owner }}">{{ .Owner }}</a></b>
      &mdash;
      <span data-testid="relative-time" title="{{ formatCommentTime .Created }}"
        >{{ relativeCommentDate .Created }}</span
      >
    </p>
    <p class="mb-0" data-sj-purpose="body">
      {{ range .CommentText.String | splitByNewline }}
        {{ . }}<br />
      {{ end }}
    </p>

    {{ if isLoggedInUser .Owner }}
      <div class="mt-3 small">
        <a href="#" data-sj-purpose="edit">Edit</a>
        &bull;
        <a
          href="#"
          hx-delete="/api/comments/{{ .ID }}"
          hx-confirm="Delete this comment?"
          hx-target="#comment{{ .ID }}"
          hx-swap="outerHTML swap:0.5s"
          data-sj-purpose="delete"
          >Delete</a
        >
      </div>
    {{ end }}
  </div>
{{ end }}
